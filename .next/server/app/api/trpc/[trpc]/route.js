"use strict";(()=>{var e={};e.id=649,e.ids=[649],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},90409:e=>{e.exports=require("payload")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},79346:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>R,originalPathname:()=>I,requestAsyncStorage:()=>E,routeModule:()=>q,serverHooks:()=>T,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>P});var o={};t.r(o),t.d(o,{GET:()=>handler,POST:()=>handler});var s=t(10884),a=t(16132),n=t(11287),i=t(80623);let l=n.z.object({category:n.z.string().optional(),sort:n.z.enum(["asc","desc"]).optional(),limit:n.z.number().optional(),searchTerm:n.z.string().optional(),liga_system:n.z.string().optional(),onSale:n.z.boolean().optional(),sortBy:n.z.string().optional(),sortOrder:n.z.enum(["asc","desc"]).optional(),names:n.z.array(n.z.string()).optional(),finalSale:n.z.boolean().optional()});var c=t(14273);let d=n.z.object({email:n.z.string().email(),password:n.z.string().min(8,{message:"Passordet m\xe5 v\xe6re minst 8 tegn langt"}),phone:n.z.string().optional().refine(e=>void 0===e||/^\d{8}$/.test(e),{message:"Telefonnummeret er ikke gyldig"})});n.z.object({email:n.z.string().email(),password:n.z.string().min(8,{message:"Passordet m\xe5 v\xe6re minst 8 tegn langt"}),phone:n.z.string().optional()});let u=c.rN.context().create(),p=u.middleware(async({ctx:e,next:r})=>{let t=e.req,{user:o}=t;if(!o||!o.id)throw new c.bR({code:"UNAUTHORIZED"});return r({ctx:{user:o}})}),g=u.router,m=u.procedure,h=u.procedure.use(p),y=g({createPayloadUser:m.input(d).mutation(async({input:e})=>{let{email:r,password:t,phone:o}=e,s=await (0,i.T)(),{docs:a}=await s.find({collection:"users",where:{email:{equals:r}}});if(0!==a.length)throw new c.bR({code:"CONFLICT"});return await s.create({collection:"users",data:{email:r,password:t,phone:o||"",role:"user"}}),{success:!0,sentToEmail:r}}),verifyEmail:m.input(n.z.object({token:n.z.string()})).query(async({input:e})=>{let{token:r}=e,t=await (0,i.T)(),o=await t.verifyEmail({collection:"users",token:r});if(!o)throw new c.bR({code:"UNAUTHORIZED"});return{success:!0}}),signIn:m.input(d).mutation(async({input:e,ctx:r})=>{let{email:t,password:o}=e,{res:s}=r,a=await (0,i.T)();try{return await a.login({collection:"users",data:{email:t,password:o},res:s}),{success:!0}}catch(e){throw new c.bR({code:"UNAUTHORIZED"})}})});var w=t(78888);let z=new w.Z(process.env.STRIPE_SECRET_KEY??"",{apiVersion:"2023-10-16",typescript:!0}),f={NO:"nok",SE:"sek",DK:"dkk",US:"usd",EU:"eur"},b=g({createSession:h.input(n.z.object({productIds:n.z.array(n.z.string()),leveringsinfo:n.z.object({navn:n.z.string(),adresse:n.z.string(),postnummer:n.z.string(),by:n.z.string(),telefonnummer:n.z.string().max(20),land:n.z.string()}),deliveryMethod:n.z.string()})).mutation(async({ctx:e,input:r})=>{console.log("Create Session called with input:",r);let{user:t}=e;if(!t)throw console.error("User context is missing"),new c.bR({code:"UNAUTHORIZED"});let{productIds:o,leveringsinfo:s,deliveryMethod:a}=r;if(0===o.length)throw console.error("No products provided"),new c.bR({code:"BAD_REQUEST"});let n=await (0,i.T)();console.log("Payload client instantiated");let l=await n.find({collection:"products",where:{id:{in:o}}}),d=l.docs;console.log("Products fetched:",d.map(e=>e.name));let u=d.filter(e=>!!e.priceId);console.log("Filtered products (with priceId):",u.map(e=>e.name));let p=await n.create({collection:"orders",data:{products:u.map(e=>e.id.toString()),user:t.id}});console.log("Order created with ID:",p.id);let g=f[s.land.toUpperCase()]||"nok",m=u.map(e=>({price_data:{currency:g,product_data:{name:e.name},unit_amount:100*(e.salePrice||e.price)},quantity:1})),h=u.reduce((e,r)=>e+(r.salePrice||r.price),0);console.log("Total price of products:",h),console.log("Delivery method:",a);let y=0;"delivery"===a&&h<1500?(y=7400,m.push({price_data:{currency:g,product_data:{name:"Delivery Fee"},unit_amount:y},quantity:1}),console.log("Delivery fee added:",y)):console.log("No delivery fee added. Delivery method:",a,"Total price:",h),console.log("Final line items prepared for Stripe Checkout:",m);try{let e=await z.customers.create({name:s.navn,phone:s.telefonnummer.substring(0,20),address:{line1:s.adresse,city:s.by,postal_code:s.postnummer,country:s.land}});console.log("Stripe customer created with ID:",e.id);let r=await z.checkout.sessions.create({success_url:`https://fotballdb.no/thank-you?orderId=${p.id}`,cancel_url:"https://fotballdb.no/cart",payment_method_types:["card","klarna"],mode:"payment",shipping_address_collection:{allowed_countries:["US","CA","GB","DE","FR","IT","ES","NL","FI","IS","CH","NO","SE","DK"]},line_items:m,metadata:{userId:t.id,orderId:p.id},customer:e.id,allow_promotion_codes:!0});return console.log("Stripe Session created:",r.id),{url:r.url}}catch(e){throw console.error("Failed to create Stripe session:",e.message),new c.bR({code:"INTERNAL_SERVER_ERROR",message:e.message})}}),pollOrderStatus:h.input(n.z.object({orderId:n.z.string()})).query(async({input:e})=>{let{orderId:r}=e;console.log("Polling status for order:",r);let t=await (0,i.T)(),{docs:o}=await t.find({collection:"orders",where:{id:{equals:r}}});if(!o.length)throw console.error("Order not found:",r),new c.bR({code:"NOT_FOUND"});let[s]=o;return{isPaid:s._isPaid}})}),x=g({searchProducts:m.input(n.z.object({searchTerm:n.z.string().optional(),category:n.z.string().optional(),size:n.z.string().optional(),sort:n.z.enum(["asc","desc"]).optional(),page:n.z.number().default(1),limit:n.z.number().default(1e3),onSale:n.z.boolean().optional()})).query(async({input:e})=>{let{searchTerm:r,category:t,size:o,sort:s="desc",page:a,limit:n,onSale:l}=e;console.log("Input received by server:",e);let c=await (0,i.T)(),d={};r&&(d.name={$regex:r,$options:"i"}),t&&(d.category=t),o&&(d.size=o),void 0!==l&&(d.onSale=l),console.log("Query constructed by server:",d);try{let{docs:e,totalDocs:r}=await c.find({collection:"products",where:{...d},sort:`${"asc"===s?"+":"-"}createdAt`,limit:n,page:a});return console.log("Products fetched by server:",e),{products:e,totalItems:r,currentPage:a,totalPages:Math.ceil(r/n)}}catch(e){throw console.error("Error fetching products:",e),Error("Error fetching products")}})}),v=g({auth:y,payment:b,product:x,getInfiniteProducts:m.input(n.z.object({limit:n.z.number().min(1).max(1e3).default(20),cursor:n.z.number().nullish(),query:l.extend({sortBy:n.z.string().optional(),sortOrder:n.z.enum(["asc","desc"]).optional(),names:n.z.array(n.z.string()).optional()})})).query(async({input:e})=>{console.log("Input received:",e);let{cursor:r,query:t}=e,{sortBy:o="createdAt",sortOrder:s="desc",limit:a,searchTerm:n,liga_system:l,names:c,...d}=t,u=await (0,i.T)(),p={};Object.entries(d).forEach(([e,r])=>{"onSale"===e?p[e]={equals:"true"===r||!0===r}:p[e]={equals:r}}),n&&(p.name={$regex:RegExp(n,"i")}),l&&(p.liga_system={equals:l}),c&&(p.name={in:c});let g=`${"desc"===s?"-":"+"}${o}`;console.log("Parsed query options:",p),console.log("Sort string:",g);try{let{docs:e,totalDocs:t}=await u.find({collection:"products",where:{approvedForSale:{equals:"approved"},...p},sort:g,depth:1,limit:a,page:r??1});return console.log(`Fetched items: ${e.length}`,e),console.log("Total documents:",t),{items:e,totalDocs:t}}catch(e){throw console.error("Error fetching products:",e),Error("Error fetching products")}})});var _=t(1603);let handler=e=>{(0,_.w)({endpoint:"/api/trpc",req:e,router:v,createContext:()=>({req:e,res:{}})})},q=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/trpc/[trpc]/route",pathname:"/api/trpc/[trpc]",filename:"route",bundlePath:"app/api/trpc/[trpc]/route"},resolvedPagePath:"/Users/torgeirhogheim/Downloads/torgeirtried-main-main 2/src/app/api/trpc/[trpc]/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:E,staticGenerationAsyncStorage:S,serverHooks:T,headerHooks:R,staticGenerationBailout:P}=q,I="/api/trpc/[trpc]/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[450,460,623],()=>__webpack_exec__(79346));module.exports=t})();